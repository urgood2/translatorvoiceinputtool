name: Fuzz Testing

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      rust_fuzz_time:
        description: 'Rust fuzzing time in seconds'
        default: '600'
        type: string
      python_fuzz_examples:
        description: 'Python hypothesis max examples per test'
        default: '1000'
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-fuzz:
    name: Rust Protocol Parser Fuzz
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev

      - name: Setup Rust nightly toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Cache fuzz corpus
        uses: actions/cache@v4
        with:
          path: src-tauri/fuzz/corpus
          key: fuzz-corpus-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-

      - name: Run fuzz tests
        working-directory: src-tauri
        run: |
          cd fuzz
          FUZZ_TIME=${{ inputs.rust_fuzz_time || '600' }}
          echo "Running fuzzer for ${FUZZ_TIME} seconds..."
          cargo +nightly fuzz run protocol_parser -- \
            -max_total_time=${FUZZ_TIME} \
            -print_final_stats=1 \
            corpus/protocol_parser/
        continue-on-error: false

      - name: Upload corpus on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-failure
          path: src-tauri/fuzz/corpus/
          retention-days: 30

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crash-artifacts
          path: |
            src-tauri/fuzz/artifacts/
            src-tauri/fuzz/corpus/protocol_parser/crash-*
          retention-days: 90

  python-fuzz:
    name: Python Protocol Parser Fuzz (Hypothesis)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev

      - name: Install dependencies
        working-directory: sidecar
        run: |
          python -m pip install --upgrade pip
          pip install hypothesis pytest
          pip install -e .

      - name: Run hypothesis fuzz tests
        working-directory: sidecar
        run: |
          MAX_EXAMPLES=${{ inputs.python_fuzz_examples || '1000' }}
          echo "Running hypothesis tests with max_examples=${MAX_EXAMPLES}..."
          # Note: hypothesis settings are configured in the test file
          # --hypothesis-seed is deprecated, using HYPOTHESIS_SEED env var instead
          pytest tests/fuzz/test_protocol_fuzz.py -v -x
        env:
          HYPOTHESIS_MAX_EXAMPLES: ${{ inputs.python_fuzz_examples || '1000' }}
          HYPOTHESIS_SEED: 0

      - name: Upload hypothesis database on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hypothesis-examples
          path: sidecar/.hypothesis/
          retention-days: 30

  fuzz-report:
    name: Generate Fuzz Report
    runs-on: ubuntu-latest
    needs: [rust-fuzz, python-fuzz]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Fuzz Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.rust-fuzz.result }}" == "success" ]; then
            echo "| Rust Protocol Parser | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Rust Protocol Parser | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.python-fuzz.result }}" == "success" ]; then
            echo "| Python Protocol Parser | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python Protocol Parser | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run triggered: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Configuration:" >> $GITHUB_STEP_SUMMARY
            echo "- Rust fuzz time: ${{ inputs.rust_fuzz_time || '600' }}s" >> $GITHUB_STEP_SUMMARY
            echo "- Python max examples: ${{ inputs.python_fuzz_examples || '1000' }}" >> $GITHUB_STEP_SUMMARY
          fi
