# M0.6: Sidecar Packaging Feasibility Spike

**Date:** 2026-02-04
**Status:** ✅ GO - Cross-platform sidecar packaging criteria satisfied in CI

## Executive Summary

The OpenVoicy sidecar can be packaged as a standalone binary using PyInstaller across Linux x64, Windows x64, macOS x64, and macOS arm64. Latest CI evidence (Build run `22152493717`, commit `239772e`) shows all four sidecar artifacts meet size/startup criteria and pass smoke command execution (`system.ping`, `audio.list_devices`, `audio.meter_start`).

## Test Results

### Required Evidence Coverage

| Platform | Evidence Status | Tracking Issue |
|----------|-----------------|----------------|
| Linux x64 | ✅ Measured | This report |
| Windows x64 | ✅ Measured | This report |
| macOS x64 | ✅ Measured | This report |
| macOS arm64 | ✅ Measured | This report |

### Platform: Linux x64 (GitHub Actions `ubuntu-latest`, run `22152493717`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 64.42 MB (67,553,736 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | ~1,087 ms | <5s and functional ping | ✅ PASS |
| `system.ping` smoke | Success response (`protocol: v1`) | Required | ✅ PASS |
| `audio.list_devices` smoke | Success response (`devices: []`) | Required | ✅ PASS |
| `audio.meter_start` smoke | JSON-RPC error response (`E_AUDIO_IO`) with process exit 0 | Required | ✅ PASS |
| Dependency footprint capture | `ldd` output captured from ELF binary | Required | ✅ PASS |

### Platform: Windows x64 (GitHub Actions `windows-latest`, run `22152493717`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 51.75 MB (54,258,668 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | ~2,289 ms | <5s and functional ping | ✅ PASS |
| `system.ping` smoke | Success response (`protocol: v1`) | Required | ✅ PASS |
| `audio.list_devices` smoke | Success response (`devices: []`) | Required | ✅ PASS |
| `audio.meter_start` smoke | JSON-RPC error response (`E_AUDIO_IO`) with process exit 0 | Required | ✅ PASS |
| Dependency footprint capture | `llvm-objdump -p` output captured from PE binary | Required | ✅ PASS |

### Platform: macOS arm64 (GitHub Actions `macos-14`, run `22152493717`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 29.89 MB (31,341,664 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | ~519 ms | <5s and functional ping | ✅ PASS |
| `system.ping` smoke | Success response (`protocol: v1`) | Required | ✅ PASS |
| `audio.list_devices` smoke | Success response (2 devices on runner) | Required | ✅ PASS |
| `audio.meter_start` smoke | Success response (`running: true`) | Required | ✅ PASS |
| Dependency footprint capture | `otool -L` output captured from Mach-O binary | Required | ✅ PASS |

### Platform: macOS x64 (GitHub Actions `macos-latest`, run `22152493717`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 29.89 MB (31,342,528 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | ~516 ms | <5s and functional ping | ✅ PASS |
| `system.ping` smoke | Success response (`protocol: v1`) | Required | ✅ PASS |
| `audio.list_devices` smoke | Success response (2 devices on runner) | Required | ✅ PASS |
| `audio.meter_start` smoke | Success response (`running: true`) | Required | ✅ PASS |
| Dependency footprint capture | `otool -L` output captured from Mach-O binary | Required | ✅ PASS |

### Binary Contents

The packaged binary includes:
- Python 3.13 runtime (embedded)
- NumPy 2.4.2
- SciPy 1.17.0
- sounddevice 0.5.5
- PortAudio 19.6.0 (system library)
- JACK audio libraries (transitive dependency)
- OpenBLAS (for NumPy/SciPy)

### Commands Tested (Linux x64 Baseline)

```bash
# system.ping - SUCCESS
$ echo '{"jsonrpc":"2.0","id":1,"method":"system.ping"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":1,"result":{"version":"0.1.0","protocol":"v1"}}

# audio.list_devices - SUCCESS
$ echo '{"jsonrpc":"2.0","id":2,"method":"audio.list_devices"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":2,"result":{"devices":[]}}

# audio.meter_start - SUCCESS (PortAudio working, no device available)
$ echo '{"jsonrpc":"2.0","id":3,"method":"audio.meter_start"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":3,"error":{"code":-32004,"message":"Error querying device -1","data":{"kind":"E_AUDIO_IO"}}}
```

## Size Projections with ML Dependencies

| Configuration | Estimated Size | Notes |
|--------------|----------------|-------|
| Audio-only (current CI range) | ~30-65 MB | Depends on target OS/arch packaging output |
| + ONNX Runtime (CPU) | ~150 MB | Recommended for MVP |
| + PyTorch (CPU) | ~400-500 MB | Near size limit |
| + PyTorch (CUDA) | ~2+ GB | Exceeds limit |

**Recommendation:** Use ONNX Runtime for MVP to stay well under 500 MB.

## Native Dependencies

### Linux x64
- libportaudio2 (PortAudio)
- libjack (JACK audio)
- libasound2 (ALSA, typically pre-installed)

### Windows x64 (TBD)
- PortAudio bundled with sounddevice
- No additional system dependencies expected

### macOS (TBD)
- PortAudio bundled with sounddevice
- CoreAudio (system framework)
- May need code signing for Gatekeeper

## Challenges Encountered

1. **Relative Import Issue**: PyInstaller did not handle relative imports in `__main__.py` for CI onefile builds.
   - **Solution:** Updated CI packaging commands to build from `entry_point.py` and added smoke assertions in the evidence collector.

2. **PortAudio Not Bundled**: sounddevice looks for system PortAudio at runtime.
   - **Solution:** Explicitly include system library in spec file.

3. **JACK Dependency**: PortAudio pulls in JACK libraries even if not used.
   - **Impact:** Adds ~2 MB to binary size. Acceptable.

## Build Artifacts

```
sidecar/
├── openvoicy_sidecar.spec    # PyInstaller spec file
├── entry_point.py            # Wrapper for PyInstaller
├── dist/
│   └── openvoicy-sidecar     # Standalone binary (platform-dependent size)
└── build/                    # Build artifacts (can be cleaned)
```

## GO/NO-GO Decision

### GO ✅

**Rationale:**
1. All required platforms are measured in CI (`linux-x64`, `windows-x64`, `macos-x64`, `macos-arm64`)
2. Binary size is below 500 MB on all platforms
3. Cold startup + functional `system.ping` is below 5 seconds on all platforms
4. Required smoke commands (`system.ping`, `audio.list_devices`, `audio.meter_start`) execute successfully across all targets

### Contingency (if ML size becomes issue)

If the full model + ONNX exceeds acceptable size:
1. Use smaller Whisper model (tiny/base instead of parakeet)
2. Download model on first run (not bundled)
3. Stream model from HuggingFace cache

The IPC contract remains unchanged regardless of backend choice.

## Next Steps

1. **M5.2:** Integrate into Tauri bundling
2. Add ONNX Runtime and test ASR model packaging
3. Keep CI smoke assertions for packaged sidecar artifacts to prevent entrypoint regressions

## Files Created

- `sidecar/openvoicy_sidecar.spec` - PyInstaller configuration
- `sidecar/entry_point.py` - PyInstaller entry wrapper
- `docs/M0.6-sidecar-packaging-spike.md` - This report
