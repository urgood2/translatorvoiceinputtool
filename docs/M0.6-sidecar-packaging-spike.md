# M0.6: Sidecar Packaging Feasibility Spike

**Date:** 2026-02-04
**Status:** ⚠️ INCOMPLETE - Linux baseline captured; Windows/macOS x64/arm64 CI packaging measured with runtime failures

## Executive Summary

The OpenVoicy sidecar can be successfully packaged as a standalone binary using PyInstaller on Linux x64 under the original spike setup. Additional CI packaging evidence now exists for Windows x64, macOS x64, and macOS arm64, and all three CI-produced binaries currently fail smoke commands at runtime with the same `ImportError` from `__main__.py`.

## Test Results

### Required Evidence Coverage

| Platform | Evidence Status | Tracking Issue |
|----------|-----------------|----------------|
| Linux x64 | ✅ Measured | This report |
| Windows x64 | ⚠️ Measured (runtime failure) | This report + `translatorvoiceinputtool-1wvk` |
| macOS x64 | ⚠️ Measured (runtime failure) | This report + `translatorvoiceinputtool-1wvk` |
| macOS arm64 | ⚠️ Measured (runtime failure) | This report + `translatorvoiceinputtool-1wvk` |

### Platform: Linux x64 (Ubuntu)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 57 MB | <500 MB | ✅ PASS |
| Startup Time | ~1.3s | <5s | ✅ PASS |
| system.ping | Works | Required | ✅ PASS |
| audio.list_devices | Works | Required | ✅ PASS |
| audio.meter_start | Works* | Required | ✅ PASS |

*Returns "no audio device" error in headless environment - PortAudio library successfully included.

### Platform: Windows x64 (GitHub Actions `windows-latest`, run `22152000008`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 7.69 MB (8,067,557 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | No successful ping (process exits in ~990 ms with ImportError) | <5s and functional ping | ❌ FAIL |
| `system.ping` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.list_devices` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.meter_start` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| Dependency footprint capture | `llvm-objdump -p` output captured from PE binary | Required | ✅ PASS |

Smoke command stderr excerpts from packaged binary:

```text
Traceback (most recent call last):
  File "__main__.py", line 3, in <module>
ImportError: attempted relative import with no known parent package
[PYI-8520:ERROR] Failed to execute script '__main__' due to unhandled exception!
```

The same import failure was observed for `audio.list_devices` and `audio.meter_start`.

### Platform: macOS arm64 (GitHub Actions `macos-14`, run `22152000008`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 6.91 MB (7,247,856 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | No successful ping (process exits in ~435 ms with ImportError) | <5s and functional ping | ❌ FAIL |
| `system.ping` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.list_devices` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.meter_start` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| Dependency footprint capture | `otool -L` output captured from Mach-O binary | Required | ✅ PASS |

Smoke command stderr excerpt from packaged binary:

```text
Traceback (most recent call last):
  File "__main__.py", line 3, in <module>
ImportError: attempted relative import with no known parent package
[PYI-2967:ERROR] Failed to execute script '__main__' due to unhandled exception!
```

The same import failure was observed for `audio.list_devices` and `audio.meter_start`.

### Platform: macOS x64 (GitHub Actions `macos-latest`, run `22152000008`, 2026-02-18)

| Metric | Value | Criteria | Status |
|--------|-------|----------|--------|
| Binary Size | 6.91 MB (7,248,944 bytes) | <500 MB | ✅ PASS |
| Cold Startup to successful `system.ping` | No successful ping (process exits in ~358 ms with ImportError) | <5s and functional ping | ❌ FAIL |
| `system.ping` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.list_devices` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| `audio.meter_start` smoke | ImportError from packaged binary | Required | ❌ FAIL |
| Dependency footprint capture | `otool -L` output captured from Mach-O binary | Required | ✅ PASS |

Smoke command stderr excerpt from packaged binary:

```text
Traceback (most recent call last):
  File "__main__.py", line 3, in <module>
ImportError: attempted relative import with no known parent package
[PYI-2041:ERROR] Failed to execute script '__main__' due to unhandled exception!
```

The same import failure was observed for `audio.list_devices` and `audio.meter_start`.

### Binary Contents

The packaged binary includes:
- Python 3.13 runtime (embedded)
- NumPy 2.4.2
- SciPy 1.17.0
- sounddevice 0.5.5
- PortAudio 19.6.0 (system library)
- JACK audio libraries (transitive dependency)
- OpenBLAS (for NumPy/SciPy)

### Commands Tested (Linux x64 Baseline)

```bash
# system.ping - SUCCESS
$ echo '{"jsonrpc":"2.0","id":1,"method":"system.ping"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":1,"result":{"version":"0.1.0","protocol":"v1"}}

# audio.list_devices - SUCCESS
$ echo '{"jsonrpc":"2.0","id":2,"method":"audio.list_devices"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":2,"result":{"devices":[]}}

# audio.meter_start - SUCCESS (PortAudio working, no device available)
$ echo '{"jsonrpc":"2.0","id":3,"method":"audio.meter_start"}' | ./openvoicy-sidecar
{"jsonrpc":"2.0","id":3,"error":{"code":-32004,"message":"Error querying device -1","data":{"kind":"E_AUDIO_IO"}}}
```

## Size Projections with ML Dependencies

| Configuration | Estimated Size | Notes |
|--------------|----------------|-------|
| Audio-only (current) | 57 MB | NumPy, SciPy, PortAudio |
| + ONNX Runtime (CPU) | ~150 MB | Recommended for MVP |
| + PyTorch (CPU) | ~400-500 MB | Near size limit |
| + PyTorch (CUDA) | ~2+ GB | Exceeds limit |

**Recommendation:** Use ONNX Runtime for MVP to stay well under 500 MB.

## Native Dependencies

### Linux x64
- libportaudio2 (PortAudio)
- libjack (JACK audio)
- libasound2 (ALSA, typically pre-installed)

### Windows x64 (TBD)
- PortAudio bundled with sounddevice
- No additional system dependencies expected

### macOS (TBD)
- PortAudio bundled with sounddevice
- CoreAudio (system framework)
- May need code signing for Gatekeeper

## Challenges Encountered

1. **Relative Import Issue**: PyInstaller doesn't handle relative imports in `__main__.py`.
   - **Solution:** Created `entry_point.py` wrapper with absolute imports.

2. **PortAudio Not Bundled**: sounddevice looks for system PortAudio at runtime.
   - **Solution:** Explicitly include system library in spec file.

3. **JACK Dependency**: PortAudio pulls in JACK libraries even if not used.
   - **Impact:** Adds ~2 MB to binary size. Acceptable.

## Build Artifacts

```
sidecar/
├── openvoicy_sidecar.spec    # PyInstaller spec file
├── entry_point.py            # Wrapper for PyInstaller
├── dist/
│   └── openvoicy-sidecar     # Standalone binary (57 MB)
└── build/                    # Build artifacts (can be cleaned)
```

## GO/NO-GO Decision

### INCOMPLETE - DO NOT CLOSE CROSS-PLATFORM PACKAGING GATE YET ⚠️

**Rationale:**
1. Linux x64 results are positive (57 MB binary, ~1.3s startup, smoke commands pass)
2. Windows x64 and macOS x64 are now measured, but packaged binary smoke commands fail due import error (`translatorvoiceinputtool-1wvk`)
3. All CI packaging targets currently fail runtime smoke due the same packaging import error
4. Cross-platform GO/NO-GO remains blocked until `translatorvoiceinputtool-1wvk` is completed

### Contingency (if ML size becomes issue)

If the full model + ONNX exceeds acceptable size:
1. Use smaller Whisper model (tiny/base instead of parakeet)
2. Download model on first run (not bundled)
3. Stream model from HuggingFace cache

The IPC contract remains unchanged regardless of backend choice.

## Next Steps

1. Complete platform evidence tasks:
   - `translatorvoiceinputtool-1wvk` (fix packaged sidecar ImportError in smoke commands)
2. **M5.2:** Integrate into Tauri bundling
3. Add ONNX Runtime and test ASR model packaging

## Files Created

- `sidecar/openvoicy_sidecar.spec` - PyInstaller configuration
- `sidecar/entry_point.py` - PyInstaller entry wrapper
- `docs/M0.6-sidecar-packaging-spike.md` - This report
